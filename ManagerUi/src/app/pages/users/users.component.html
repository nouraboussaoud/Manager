<div class="users-container">
  <div class="mmm-header">
    <div class="header-content">
      <h1 class="mmm-title">User Management</h1>
      <p class="mmm-subtitle">Manage your organization's users and their access permissions</p>
    </div>
    <div class="header-actions">
      <button class="mmm-button mmm-button-primary" (click)="openCreateModal()">
        <clr-icon shape="plus"></clr-icon>
        Add New User
      </button>
    </div>
  </div>
  
  <div class="mmm-card filters-section">
    <div class="search-container">
      <clr-input-container>
        <label>Search Users</label>
        <input 
          clrInput 
          type="text" 
          placeholder="Search by name or email..." 
          [(ngModel)]="searchTerm"
          (input)="filterUsers()">
        <clr-icon shape="search" clrSuffix></clr-icon>
      </clr-input-container>
    </div>
    
    <div class="filter-tabs">
      <clr-tabs>
        <clr-tab>
          <button 
            clrTabLink 
            [class.active]="activeFilter === 'all'"
            (click)="setFilter('all')">
            All Users ({{ users.length }})
          </button>
          <clr-tab-content *clrIfActive="activeFilter === 'all'">
            <!-- Content handled by main grid -->
          </clr-tab-content>
        </clr-tab>
        <clr-tab>
          <button 
            clrTabLink 
            [class.active]="activeFilter === 'active'"
            (click)="setFilter('active')">
            Active ({{ getActiveCount() }})
          </button>
          <clr-tab-content *clrIfActive="activeFilter === 'active'">
            <!-- Content handled by main grid -->
          </clr-tab-content>
        </clr-tab>
        <clr-tab>
          <button 
            clrTabLink 
            [class.active]="activeFilter === 'inactive'"
            (click)="setFilter('inactive')">
            Inactive ({{ getInactiveCount() }})
          </button>
          <clr-tab-content *clrIfActive="activeFilter === 'inactive'">
            <!-- Content handled by main grid -->
          </clr-tab-content>
        </clr-tab>
      </clr-tabs>
    </div>
  </div>
  
  <!-- Loading State -->
  <div *ngIf="loading" class="loading-state">
    <clr-spinner clrMedium>Loading users...</clr-spinner>
  </div>
  
  <!-- Error State -->
  <div *ngIf="error" class="mmm-card error-state">
    <div class="mmm-alert mmm-alert-error">
      <clr-icon shape="exclamation-triangle"></clr-icon>
      <div>
        <h3>Error Loading Users</h3>
        <p>{{ error }}</p>
      </div>
    </div>
    <button class="mmm-button mmm-button-primary" (click)="loadUsers()">
      <clr-icon shape="refresh"></clr-icon>
      Try Again
    </button>
  </div>
  
  <!-- Users Data Grid -->
  <div *ngIf="!loading && !error" class="users-content">
    <clr-datagrid [(clrDgSelected)]="selectedUsers" [clrDgLoading]="loading">
      <clr-dg-action-bar>
        <div class="btn-group">
          <button 
            class="mmm-button mmm-button-primary" 
            (click)="openCreateModal()"
            *ngIf="selectedUsers.length === 0">
            <clr-icon shape="plus"></clr-icon>
            Add User
          </button>
          <button 
            class="mmm-button mmm-button-secondary" 
            (click)="editSelectedUser()"
            *ngIf="selectedUsers.length === 1">
            <clr-icon shape="pencil"></clr-icon>
            Edit
          </button>
          <button 
            class="mmm-button mmm-button-outline" 
            (click)="toggleSelectedUsers()"
            *ngIf="selectedUsers.length > 0">
            <clr-icon shape="toggle"></clr-icon>
            Toggle Status
          </button>
          <button 
            class="mmm-button" 
            style="background: var(--error-color); color: white;"
            (click)="deleteSelectedUsers()"
            *ngIf="selectedUsers.length > 0">
            <clr-icon shape="trash"></clr-icon>
            Delete ({{ selectedUsers.length }})
          </button>
        </div>
      </clr-dg-action-bar>
      
      <clr-dg-column [clrDgField]="'firstname'">
        <clr-icon shape="user"></clr-icon>
        Name
      </clr-dg-column>
      <clr-dg-column [clrDgField]="'email'">
        <clr-icon shape="email"></clr-icon>
        Email
      </clr-dg-column>
      <clr-dg-column [clrDgField]="'enabled'">
        <clr-icon shape="check-circle"></clr-icon>
        Status
      </clr-dg-column>
      <clr-dg-column>
        <clr-icon shape="calendar"></clr-icon>
        Created Date
      </clr-dg-column>
      <clr-dg-column>
        <clr-icon shape="cog"></clr-icon>
        Actions
      </clr-dg-column>
      
      <clr-dg-row *clrDgItems="let user of filteredUsers" [clrDgItem]="user">
        <clr-dg-cell>
          <div class="user-name-cell">
            <div class="user-avatar">
              <clr-icon shape="user" size="20"></clr-icon>
            </div>
            <div class="user-details">
              <span class="user-name">{{ user.firstname }} {{ user.lastname }}</span>
              <small class="user-roles" *ngIf="user.roles && user.roles.length > 0">
                {{ user.roles.join(', ') }}
              </small>
            </div>
          </div>
        </clr-dg-cell>
        <clr-dg-cell>{{ user.email }}</clr-dg-cell>
        <clr-dg-cell>
          <clr-badge 
            [status]="user.enabled ? 'success' : 'danger'">
            {{ user.enabled ? 'Active' : 'Inactive' }}
          </clr-badge>
        </clr-dg-cell>
        <clr-dg-cell>
          <span *ngIf="user.createdDate">{{ user.createdDate | date:'short' }}</span>
          <span *ngIf="!user.createdDate" class="text-muted">â€”</span>
        </clr-dg-cell>
        <clr-dg-cell>
          <clr-dropdown>
            <button class="mmm-button mmm-button-outline" clrDropdownTrigger>
              <clr-icon shape="ellipsis-horizontal"></clr-icon>
            </button>
            <clr-dropdown-menu *clrIfOpen>
              <button clrDropdownItem (click)="editUser(user)">
                <clr-icon shape="pencil"></clr-icon>
                Edit User
              </button>
              <button clrDropdownItem (click)="toggleUserStatus(user)">
                <clr-icon [shape]="user.enabled ? 'pause' : 'play'"></clr-icon>
                {{ user.enabled ? 'Deactivate' : 'Activate' }}
              </button>
              <button clrDropdownItem (click)="resetPassword(user)">
                <clr-icon shape="key"></clr-icon>
                Reset Password
              </button>
              <div class="dropdown-divider"></div>
              <button clrDropdownItem (click)="deleteUser(user)" class="text-danger">
                <clr-icon shape="trash"></clr-icon>
                Delete User
              </button>
            </clr-dropdown-menu>
          </clr-dropdown>
        </clr-dg-cell>
      </clr-dg-row>
      
      <clr-dg-footer>
        <clr-dg-pagination 
          #pagination 
          [clrDgPageSize]="10" 
          [clrDgTotalItems]="filteredUsers.length">
          <clr-dg-page-size [clrPageSizeOptions]="[10, 20, 50, 100]">Users per page</clr-dg-page-size>
          {{ pagination.firstItem + 1 }} - {{ pagination.lastItem + 1 }} of {{ pagination.totalItems }} users
        </clr-dg-pagination>
      </clr-dg-footer>
    </clr-datagrid>
  </div>
  
  <!-- Empty State -->
  <div *ngIf="!loading && !error && filteredUsers.length === 0" class="mmm-card empty-state">
    <div class="empty-icon">
      <clr-icon shape="users" size="64"></clr-icon>
    </div>
    <h3>No Users Found</h3>
    <p *ngIf="searchTerm">No users match your search criteria.</p>
    <p *ngIf="!searchTerm">Get started by adding your first user.</p>
    <button class="mmm-button mmm-button-primary" (click)="openCreateModal()">
      <clr-icon shape="plus"></clr-icon>
      Add First User
    </button>
  </div>
</div>

<!-- User Form Modal -->
<app-modal 
  [isOpen]="isModalOpen" 
  [title]="modalTitle" 
  (closeModal)="closeModal()">
  <app-user-form 
    [user]="selectedUser" 
    [isEditMode]="isEditMode"
    (userSaved)="onUserSaved($event)"
    (formCancelled)="closeModal()">
  </app-user-form>
</app-modal>

<!-- Confirmation Modals -->
<clr-modal [(clrModalOpen)]="showDeleteConfirm" [clrModalSize]="'sm'">
  <h3 class="modal-title">Confirm Deletion</h3>
  <div class="modal-body">
    <p>Are you sure you want to delete the selected user(s)? This action cannot be undone.</p>
  </div>
  <div class="modal-footer">
    <button type="button" class="mmm-button mmm-button-outline" (click)="showDeleteConfirm = false">
      Cancel
    </button>
    <button type="button" class="mmm-button" style="background: var(--error-color); color: white;" (click)="confirmDelete()">
      <clr-icon shape="trash"></clr-icon>
      Delete
    </button>
  </div>
</clr-modal>
